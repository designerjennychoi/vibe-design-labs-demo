<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë‰´ìŠ¤ ë¸Œë¦¬í•‘</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-icon">ğŸ“°</div>
      <h1 class="header-title">ë‰´ìŠ¤ ë¸Œë¦¬í•‘</h1>
      <p class="header-subtitle">ê´€ì‹¬ í‚¤ì›Œë“œì˜ ìµœì‹  ë‰´ìŠ¤ë¥¼ AIê°€ ìš”ì•½í•´ ë“œë¦½ë‹ˆë‹¤</p>
    </header>

    <!-- Keyword Input Section -->
    <section class="input-section">
      <h2 class="section-title">ê´€ì‹¬ í‚¤ì›Œë“œ ì…ë ¥</h2>
      <p class="section-hint">ìµœëŒ€ 5ê°œì˜ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>

      <div class="keywords-wrapper" id="keywordsWrapper">
        <div class="keyword-row" data-index="0">
          <span class="keyword-number">1</span>
          <input
            type="text"
            class="keyword-input"
            placeholder="ì˜ˆ: ì¸ê³µì§€ëŠ¥, ì£¼ì‹ì‹œì¥, ê¸°í›„ë³€í™”..."
            maxlength="50"
          />
          <button class="btn-remove" onclick="removeKeyword(this)" title="ì‚­ì œ">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>

      <button class="btn-add" id="addKeywordBtn" onclick="addKeyword()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        í‚¤ì›Œë“œ ì¶”ê°€
      </button>

      <button class="btn-search" id="searchBtn" onclick="startSearch()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        ë‰´ìŠ¤ ë¸Œë¦¬í•‘ ì‹œì‘
      </button>
    </section>

    <!-- Loading -->
    <div class="loading-section" id="loadingSection" style="display: none;">
      <div class="loading-spinner"></div>
      <p class="loading-text">ë‰´ìŠ¤ë¥¼ ê²€ìƒ‰í•˜ê³  AIê°€ ìš”ì•½í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
      <p class="loading-sub">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”</p>
    </div>

    <!-- Error -->
    <div class="error-section" id="errorSection" style="display: none;">
      <div class="error-icon">âš ï¸</div>
      <p class="error-text" id="errorText"></p>
    </div>

    <!-- Results -->
    <section class="results-section" id="resultsSection" style="display: none;">
      <div class="results-header">
        <h2 class="section-title">ë‰´ìŠ¤ ë¸Œë¦¬í•‘ ê²°ê³¼</h2>
        <span class="results-badge" id="resultsBadge"></span>
      </div>
      <div class="cards-grid" id="cardsGrid"></div>
    </section>
  </div>

  <script>
    const MAX_KEYWORDS = 5;

    function updateNumbers() {
      const rows = document.querySelectorAll('.keyword-row');
      rows.forEach((row, i) => {
        row.querySelector('.keyword-number').textContent = i + 1;
        row.dataset.index = i;
      });
      // ì‚­ì œ ë²„íŠ¼: 1ê°œë§Œ ë‚¨ìœ¼ë©´ ìˆ¨ê¸°ê¸°
      document.querySelectorAll('.btn-remove').forEach(btn => {
        btn.style.visibility = rows.length > 1 ? 'visible' : 'hidden';
      });
      // ì¶”ê°€ ë²„íŠ¼: 5ê°œ ë„ë‹¬í•˜ë©´ ìˆ¨ê¸°ê¸°
      document.getElementById('addKeywordBtn').style.display =
        rows.length >= MAX_KEYWORDS ? 'none' : 'flex';
    }

    function addKeyword() {
      const wrapper = document.getElementById('keywordsWrapper');
      if (wrapper.querySelectorAll('.keyword-row').length >= MAX_KEYWORDS) return;

      const row = document.createElement('div');
      row.className = 'keyword-row';
      row.innerHTML = `
        <span class="keyword-number"></span>
        <input type="text" class="keyword-input" placeholder="í‚¤ì›Œë“œ ì…ë ¥..." maxlength="50" />
        <button class="btn-remove" onclick="removeKeyword(this)" title="ì‚­ì œ">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      `;
      wrapper.appendChild(row);
      row.querySelector('.keyword-input').focus();
      updateNumbers();
    }

    function removeKeyword(btn) {
      const rows = document.querySelectorAll('.keyword-row');
      if (rows.length <= 1) return;
      btn.closest('.keyword-row').remove();
      updateNumbers();
    }

    function getKeywords() {
      return Array.from(document.querySelectorAll('.keyword-input'))
        .map(input => input.value.trim())
        .filter(v => v.length > 0);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      return dateStr;
    }

    function renderCards(results) {
      const grid = document.getElementById('cardsGrid');
      grid.innerHTML = '';

      results.forEach((item, i) => {
        const card = document.createElement('div');
        card.className = 'news-card';
        card.style.animationDelay = `${i * 0.08}s`;

        const articlesHTML = item.articles.length > 0
          ? item.articles.map(a => `
              <a href="${a.url}" target="_blank" rel="noopener noreferrer" class="article-link">
                <div class="article-info">
                  <span class="article-source">${a.source || 'ì¶œì²˜ ì—†ìŒ'}</span>
                  <span class="article-date">${a.publishedAt}</span>
                </div>
                <span class="article-title">${a.title}</span>
                <svg class="article-arrow" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="7" y1="17" x2="17" y2="7"></line>
                  <polyline points="7 7 17 7 17 17"></polyline>
                </svg>
              </a>
            `).join('')
          : '<p class="no-articles">ê´€ë ¨ ê¸°ì‚¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';

        card.innerHTML = `
          <div class="card-header">
            <span class="card-tag">#${item.keyword}</span>
          </div>
          <div class="card-summary">
            <div class="summary-label">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"></path>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
              </svg>
              AI ìš”ì•½
            </div>
            <p class="summary-text">${item.summary}</p>
          </div>
          <div class="card-articles">
            <div class="articles-label">ê´€ë ¨ ê¸°ì‚¬ ${item.articles.length}ê±´</div>
            <div class="articles-list">${articlesHTML}</div>
          </div>
        `;

        grid.appendChild(card);
      });
    }

    async function startSearch() {
      const keywords = getKeywords();
      if (keywords.length === 0) {
        alert('í‚¤ì›Œë“œë¥¼ ìµœì†Œ 1ê°œ ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }

      // UI ìƒíƒœ ì „í™˜
      document.getElementById('searchBtn').disabled = true;
      document.getElementById('loadingSection').style.display = 'flex';
      document.getElementById('errorSection').style.display = 'none';
      document.getElementById('resultsSection').style.display = 'none';

      try {
        const response = await fetch('/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keywords }),
        });

        const data = await response.json();

        if (!response.ok || data.error) {
          throw new Error(data.error || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }

        document.getElementById('resultsBadge').textContent = `í‚¤ì›Œë“œ ${data.results.length}ê°œ`;
        renderCards(data.results);
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch (err) {
        document.getElementById('errorText').textContent = err.message;
        document.getElementById('errorSection').style.display = 'flex';
      } finally {
        document.getElementById('loadingSection').style.display = 'none';
        document.getElementById('searchBtn').disabled = false;
      }
    }

    // ì—”í„°í‚¤ë¡œ ê²€ìƒ‰
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) startSearch();
    });

    // ì´ˆê¸°í™”
    updateNumbers();
  </script>
</body>
</html>
